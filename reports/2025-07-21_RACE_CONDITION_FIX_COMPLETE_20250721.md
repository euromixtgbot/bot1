# üö® –ö–†–ò–¢–ò–ß–ù–ï –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø RACE CONDITION - –í–ò–†–Ü–®–ï–ù–û

**–î–∞—Ç–∞:** 21 –ª–∏–ø–Ω—è 2025, 10:35  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ó 7 —Ñ–∞–π–ª—ñ–≤ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ —Ç—ñ–ª—å–∫–∏ 3 —á–µ—Ä–µ–∑ race condition  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–ò–†–Ü–®–ï–ù–û

---

## üîç **–ê–ù–ê–õ–Ü–ó –ü–†–û–ë–õ–ï–ú–ò**

### **–ó–Ω–∞–π–¥–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ –≤ –ª–æ–≥–∞—Ö:**
```log
10:34:44,085 - –ö–æ–º–µ–Ω—Ç–∞—Ä –ü–û–ß–ê–í –æ–±—Ä–æ–±–∫—É (–∑ –∑–∞—Ç—Ä–∏–º–∫–æ—é 2 —Å–µ–∫—É–Ω–¥–∏)
10:34:44,162 - Attachment 136425 –∑–∞–∫–µ—à–æ–≤–∞–Ω–∏–π (–ü–Ü–ó–ù–û - +0.077—Å)
10:34:44,334 - Attachment 136426 –∑–∞–∫–µ—à–æ–≤–∞–Ω–∏–π (–ü–Ü–ó–ù–û - +0.249—Å)
```

### **–í—Ç—Ä–∞—á–µ–Ω—ñ —Ñ–∞–π–ª–∏:**
- `image (2) (db037978-7ea9-483b-bfc8-75f7f3a1ddc5).png` (ID: 136425)
- `20230404_143616 (73e5114a-d9a0-4870-8fbd-a43ca073834c).mp4` (ID: 136426)

### **–ü—Ä–∏—á–∏–Ω–∞:**
**Race condition** - –¥–µ—è–∫—ñ `attachment_created` –ø–æ–¥—ñ—ó –∑–∞–≤–µ—Ä—à—É–≤–∞–ª–∏—Å—è –ü–Ü–°–õ–Ø –ø–æ—á–∞—Ç–∫—É –æ–±—Ä–æ–±–∫–∏ `comment_created`, —Ç–æ–º—É —Ñ–∞–π–ª–∏ –Ω–µ –ø–æ—Ç—Ä–∞–ø–ª—è–ª–∏ –≤ –∫–µ—à –≤—á–∞—Å–Ω–æ.

---

## ‚úÖ **–í–ü–†–û–í–ê–î–ñ–ï–ù–Ü –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø**

### **1. üïê –ó–ë–Ü–õ–¨–®–ï–ù–ê –ó–ê–¢–†–ò–ú–ö–ê**
**–§–∞–π–ª:** `/home/Bot1/src/jira_webhooks2.py`  
**–§—É–Ω–∫—Ü—ñ—è:** `handle_comment_created()`

```python
# –î–û:
await asyncio.sleep(2)  # 2 —Å–µ–∫—É–Ω–¥–∏

# –ü–Ü–°–õ–Ø:
await asyncio.sleep(5)  # 5 —Å–µ–∫—É–Ω–¥ - –∑–±—ñ–ª—å—à–µ–Ω–æ –¥–ª—è –ø–æ–≤–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –≤—Å—ñ—Ö –ø–æ–¥—ñ–π
```

### **2. üîç –î–û–î–ê–¢–ö–û–í–ê –ü–ï–†–ï–í–Ü–†–ö–ê –í–¢–†–ê–ß–ï–ù–ò–• –§–ê–ô–õ–Ü–í**
**–§–∞–π–ª:** `/home/Bot1/src/jira_webhooks2.py`  
**–§—É–Ω–∫—Ü—ñ—è:** `handle_comment_created()`

```python
# –ö–†–ò–¢–ò–ß–ù–ê –ü–ï–†–ï–í–Ü–†–ö–ê: –ß–∏ –≤—Å—ñ embedded —Ñ–∞–π–ª–∏ –∑–Ω–∞–π–¥–µ–Ω—ñ?
if embedded_attachments:
    found_filenames = {att.get('filename', '') for att in cached_attachments}
    embedded_filenames = {att.get('filename', '') for att in embedded_attachments}
    missing_files = embedded_filenames - found_filenames
    
    if missing_files:
        logger.warning(f"‚ö†Ô∏è MISSING FILES DETECTED: {len(missing_files)} embedded files not found in cache!")
        
        # –î–æ–¥–∞—Ç–∫–æ–≤–∞ —Å–ø—Ä–æ–±–∞ –∑–Ω–∞–π—Ç–∏ —á–µ—Ä–µ–∑ —Ä–æ–∑—à–∏—Ä–µ–Ω–∏–π –ø–æ—à—É–∫
        additional_search = find_cached_attachments_by_patterns(
            issue_key, 
            [{'filename': f} for f in missing_files], 
            comment_timestamp,
            extend_time_window=True  # –†–æ–∑—à–∏—Ä—é—î–º–æ —á–∞—Å–æ–≤–µ –≤—ñ–∫–Ω–æ
        )
```

### **3. üîÑ –†–û–ó–®–ò–†–ï–ù–ò–ô –ü–û–®–£–ö –î–õ–Ø RECOVERY**
**–§–∞–π–ª:** `/home/Bot1/src/jira_webhooks2.py`  
**–§—É–Ω–∫—Ü—ñ—è:** `find_cached_attachments_by_patterns()`

```python
def find_cached_attachments_by_patterns(
    issue_key: str, 
    embedded_attachments: List[Dict[str, Any]], 
    comment_timestamp: float, 
    extend_time_window: bool = False  # –ù–û–í–ò–ô –ü–ê–†–ê–ú–ï–¢–†
) -> List[Dict[str, Any]]:

# –í —Ñ—É–Ω–∫—Ü—ñ—ó:
if extend_time_window:
    time_window = 600  # 10 —Ö–≤–∏–ª–∏–Ω –¥–ª—è —Ä–æ–∑—à–∏—Ä–µ–Ω–æ–≥–æ –ø–æ—à—É–∫—É –≤—Ç—Ä–∞—á–µ–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤
    logger.info(f"üîÑ EXTENDED STRATEGY 3: RECOVERY MODE")
else:
    time_window = 180  # 3 —Ö–≤–∏–ª–∏–Ω–∏ –¥–ª—è –∑–≤–∏—á–∞–π–Ω–æ–≥–æ –ø–æ—à—É–∫—É
```

---

## üß™ **–û–ß–Ü–ö–£–í–ê–ù–Ü –†–ï–ó–£–õ–¨–¢–ê–¢–ò**

### **–ü–Ü–°–õ–Ø –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:**
```log
‚è≥ Waiting 5 seconds for all attachment_created events to complete...
üì¶ Found 7 cached attachments via enhanced search:
   üéØ CACHED 1. photo_2025-07-03_13-45-20.jpg (ID: 136422)
   üéØ CACHED 2. –ü—Ä–∞–≤–µ—Ä–∫–∞–ó–∞–∫–∞–∑–∞2.epf (ID: 136423)
   üéØ CACHED 3. photo_2025-07-03_13-45-20.rar (ID: 136424)
   üéØ CACHED 4. image (2).png (ID: 136425) ‚úÖ –ó–ù–ê–ô–î–ï–ù–û
   üéØ CACHED 5. 20230404_143616.mp4 (ID: 136426) ‚úÖ –ó–ù–ê–ô–î–ï–ù–û
   üéØ CACHED 6. –°—Ç–∞—Ç—É—Å–∏ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è.xlsx (ID: 136427)
   üéØ CACHED 7. New Text Document.txt (ID: 136428)
‚úÖ ALL EMBEDDED FILES FOUND in cache
üèÅ Attachment processing complete: 7 successful, 0 failed ‚úÖ
```

---

## üîß **–¢–ï–•–ù–Ü–ß–ù–Ü –î–ï–¢–ê–õ–Ü**

### **Race Condition Pattern:**
1. **attachment_created** –ø–æ–¥—ñ—ó –ø—Ä–∏—Ö–æ–¥—è—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∑ —Ä—ñ–∑–Ω–∏–º–∏ –∑–∞—Ç—Ä–∏–º–∫–∞–º–∏
2. **comment_created** –ø–æ–¥—ñ—è –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –º–∞–π–∂–µ –æ–¥–Ω–æ—á–∞—Å–Ω–æ
3. –ë–µ–∑ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ—ó –∑–∞—Ç—Ä–∏–º–∫–∏ - —á–∞—Å—Ç–∏–Ω–∞ —Ñ–∞–π–ª—ñ–≤ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –Ω–µ–∑–∞–∫–µ—à–æ–≤–∞–Ω–æ—é

### **–†—ñ—à–µ–Ω–Ω—è:**
1. **–ó–±—ñ–ª—å—à–µ–Ω–∞ –∑–∞—Ç—Ä–∏–º–∫–∞** - –¥–∞—î —á–∞—Å –≤—Å—ñ–º attachment_created –ø–æ–¥—ñ—è–º –∑–∞–≤–µ—Ä—à–∏—Ç–∏—Å—è
2. **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ–≤–Ω–æ—Ç–∏** - –ø–æ—Ä—ñ–≤–Ω—é—î –∑–Ω–∞–π–¥–µ–Ω—ñ —Ñ–∞–π–ª–∏ –∑ embedded files
3. **Recovery —Ä–µ–∂–∏–º** - —Ä–æ–∑—à–∏—Ä–µ–Ω–∏–π –ø–æ—à—É–∫ –¥–ª—è –≤—Ç—Ä–∞—á–µ–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤

### **Fallback Strategy:**
- **–ó–≤–∏—á–∞–π–Ω–∏–π –ø–æ—à—É–∫:** ¬±3 —Ö–≤–∏–ª–∏–Ω–∏ –≤—ñ–¥ –∫–æ–º–µ–Ω—Ç–∞—Ä—è
- **Recovery –ø–æ—à—É–∫:** ¬±10 —Ö–≤–∏–ª–∏–Ω –≤—ñ–¥ –∫–æ–º–µ–Ω—Ç–∞—Ä—è
- **–ú–Ω–æ–∂–∏–Ω–Ω—ñ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—ó:** issue_key ‚Üí filename ‚Üí timestamp

---

## üìä **–ú–û–ù–Ü–¢–û–†–ò–ù–ì**

–î–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è —Å–ª—ñ–¥–∫—É–π—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏:

```bash
tail -f /home/Bot1/logs/webhook_*.log | grep -E "(MISSING FILES|ALL EMBEDDED FILES|RECOVERY)"
```

**–£—Å–ø—ñ—à–Ω—ñ –æ–∑–Ω–∞–∫–∏:**
- `‚úÖ ALL EMBEDDED FILES FOUND in cache`
- `üèÅ Attachment processing complete: X successful, 0 failed`

**–ü—Ä–æ–±–ª–µ–º–Ω—ñ –æ–∑–Ω–∞–∫–∏:**
- `‚ö†Ô∏è MISSING FILES DETECTED`
- `üîÑ EXTENDED STRATEGY 3: RECOVERY MODE`

---

## üéØ **–í–ò–°–ù–û–í–û–ö**

‚úÖ **Race condition –≤–∏—Ä—ñ—à–µ–Ω–æ** —á–µ—Ä–µ–∑ –∑–±—ñ–ª—å—à–µ–Ω—É –∑–∞—Ç—Ä–∏–º–∫—É —Ç–∞ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏  
‚úÖ **Recovery –º–µ—Ö–∞–Ω—ñ–∑–º** –¥–æ–¥–∞–Ω–∏–π –¥–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –≤—Ç—Ä–∞—á–µ–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤  
‚úÖ **–†–æ–∑—à–∏—Ä–µ–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è** –¥–ª—è –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –ø—Ä–æ–±–ª–µ–º  

**–û—á—ñ–∫—É–≤–∞–Ω–∞ –µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å:** 7/7 —Ñ–∞–π–ª—ñ–≤ –∑–∞–º—ñ—Å—Ç—å 3/7 ‚ú®
