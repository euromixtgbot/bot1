# План покриття тестами (стан на 13.10.2025)

## 1. Стратегія
- **Unit-тести** перевіряють чисті функції та локальну бізнес-логіку без зовнішніх залежностей.
- **Інтеграційні тести** імітують ключові сценарії взаємодії модулів, використовуючи `monkeypatch` замість реальних сервісів (Google Sheets, Jira, Telegram).
- **Розширення**: наступні ітерації додадуть E2E-сценарії для Telegram і обробки Jira вебхуків через тестову чергу.

## 2. Поточне покриття

| Рівень | Файл | Що перевіряємо | Основні перевірки |
| --- | --- | --- | --- |
| Unit | `Tests/unit/test_handlers_utils.py` | Функції `validate_phone_format`, `check_main_menu_button_and_exit` | Валідні/невалідні телефони, очищення стану при натисканні кнопок меню, реакція на довільний текст |
| Unit | `Tests/unit/test_user_state_service.py` | Збереження/читання станів та профілів, синхронізація, завершення реєстрації | Створення/видалення файлів, збереження `bot_state`, оновлення `sync_with_google`, перехід у стан `AUTHORIZED_NO_TASKS` |
| Integration | `Tests/integration/test_user_management.py` | `UserManager.authorize_user` у сценаріях успіху та аварій | Оновлення Google (мок), запис у кеш, fallback до локальних даних, статус `authorized` |

## 3. Пріоритети наступних хвиль тестування
1. **Telegram ConversationHandler**: макети оновлень для кроків створення задачі (FULL_NAME → CONFIRM), перевірка реакції на кнопки/вкладення.
2. **Jira вебхуки**: тестування `handle_comment_created` з чергою вкладень, сценарії без користувача або з відкладеними файлами.
3. **Захист авторизації контактів**: додати тест після впровадження перевірки `contact.user_id`.
4. **Фоновий цикл синхронізації**: імітація `sync_pending_users` із чергою записів та помилками під час запису в Google.
5. **Моніторинг/healthcheck**: перевірка, що `/healthz` та метрики повертають коректні дані (після реалізації).

## 4. Запуск тестів
```bash
source venv/bin/activate
pytest  # запускає весь набір
pytest Tests/unit -m unit
pytest Tests/integration -m integration
```

## 5. Організаційні нотатки
- У `Tests/conftest.py` застосовано автоматичний фікстур для ізоляції файлового кешу (`UserStateManager`).
- Зовнішні сервіси замінені mock-функціями; перед інтеграцією з реальними API необхідно додати контракти/специфікації.
- Після кожної суттєвої зміни логіки оновлюємо таблицю в розділі «Поточне покриття» та додаємо нові тести.
