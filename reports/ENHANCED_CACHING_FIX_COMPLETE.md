# üéØ –ö–†–ò–¢–ò–ß–ù–ï –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø –°–ò–°–¢–ï–ú–ò –ö–ï–®–£–í–ê–ù–ù–Ø –§–ê–ô–õ–Ü–í

**–î–∞—Ç–∞:** 11 –ª–∏–ø–Ω—è 2025  
**–°—Ç–∞—Ç—É—Å:** –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø –í–ü–†–û–í–ê–î–ñ–ï–ù–û  
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–û–í–ê –°–ò–°–¢–ï–ú–ê –ö–ï–®–£–í–ê–ù–ù–Ø –ó FALLBACK –°–¢–†–ê–¢–ï–ì–Ü–Ø–ú–ò

## üîß –í–ü–†–û–í–ê–î–ñ–ï–ù–Ü –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø

### **1. ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –í–Ü–î–°–£–¢–ù–Ü–°–¢–¨ ISSUE_KEY –í ATTACHMENT_CREATED**

**–í–∏—è–≤–ª–µ–Ω–æ:** `attachment_created` webhook –ø–æ–¥—ñ—ó –ù–ï –º—ñ—Å—Ç—è—Ç—å –ø–æ–ª–µ `issue`  
**–°–∏–º–ø—Ç–æ–º:** –í–∫–ª–∞–¥–µ–Ω–Ω—è –Ω–µ –∫–µ—à—É–≤–∞–ª–∏—Å—è —á–µ—Ä–µ–∑ –Ω–µ–≤—ñ–¥–æ–º–∏–π `issue_key`  

**‚úÖ –†–Ü–®–ï–ù–ù–Ø:**
- –°—Ç–≤–æ—Ä–µ–Ω–æ **–¥–≤–æ—Å—Ç—É–ø–µ–Ω–µ–≤—É —Å–∏—Å—Ç–µ–º—É –∫–µ—à—É–≤–∞–Ω–Ω—è**
- **–û—Å–Ω–æ–≤–Ω–∏–π –∫–µ—à:** –∑–∞ `issue_key` (–∫–æ–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∏–π)
- **Fallback –∫–µ—à:** –∑–∞ `attachment_id` (–∫–æ–ª–∏ `issue_key` –Ω–µ–≤—ñ–¥–æ–º–∏–π)

```python
# –ù–û–í–ò–ô –ì–õ–û–ë–ê–õ–¨–ù–ò–ô –ö–ï–® –ó–ê ATTACHMENT_ID
ATTACHMENT_ID_CACHE: Dict[str, Dict[str, Any]] = {}
ATTACHMENT_ID_CACHE_TTL = 120  # 2 minutes
```

---

### **2. üîç –ù–û–í–ê –°–¢–†–ê–¢–ï–ì–Ü–Ø –ü–û–®–£–ö–£ –§–ê–ô–õ–Ü–í**

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–∞–≤—ñ—Ç—å –∑–∞–∫–µ—à–æ–≤–∞–Ω—ñ —Ñ–∞–π–ª–∏ –Ω–µ –∑–Ω–∞—Ö–æ–¥–∏–ª–∏—Å—è –ø—Ä–∏ `comment_created`

**‚úÖ –†–Ü–®–ï–ù–ù–Ø:** –í–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–æ **3 —Å—Ç—Ä–∞—Ç–µ–≥—ñ—ó –ø–æ—à—É–∫—É:**

#### **–°–¢–†–ê–¢–ï–ì–Ü–Ø 1: –ü–æ—à—É–∫ –∑–∞ Issue Key** (–æ—Å–Ω–æ–≤–Ω–∏–π)
```python
# –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –ø–æ—à—É–∫ –≤ PENDING_ATTACHMENTS_CACHE[issue_key]
direct_cached = get_cached_attachments(issue_key)
```

#### **–°–¢–†–ê–¢–ï–ì–Ü–Ø 2: –ü–æ—à—É–∫ –∑–∞ —ñ–º–µ–Ω–∞–º–∏ —Ñ–∞–π–ª—ñ–≤** (fallback)
```python
# –ó—ñ—Å—Ç–∞–≤–ª—è—î–º–æ embedded filenames –∑ –∫–µ—à–æ–≤–∞–Ω–∏–º–∏
for embedded_filename in embedded_filenames:
    if files_match(cached_filename, embedded_filename):
        # –ó–Ω–∞–π–¥–µ–Ω–æ —Å–ø—ñ–≤–ø–∞–¥—ñ–Ω–Ω—è!
```

#### **–°–¢–†–ê–¢–ï–ì–Ü–Ø 3: –ü–æ—à—É–∫ –∑–∞ —á–∞—Å–æ–≤–∏–º–∏ –º—ñ—Ç–∫–∞–º–∏** (–æ—Å—Ç–∞–Ω–Ω—ñ–π fallback)
```python
# –®—É–∫–∞—î–º–æ —Ñ–∞–π–ª–∏ –≤ –º–µ–∂–∞—Ö ¬±30 —Å–µ–∫—É–Ω–¥ –≤—ñ–¥ –∫–æ–º–µ–Ω—Ç–∞—Ä—è
if abs(comment_timestamp - cached_timestamp) <= 30:
    # –§–∞–π–ª —Å—Ç–≤–æ—Ä–µ–Ω–∏–π –±–ª–∏–∑—å–∫–æ –¥–æ —á–∞—Å—É –∫–æ–º–µ–Ω—Ç–∞—Ä—è
```

---

### **3. üß© –†–û–ó–£–ú–ù–ï –ó–Ü–°–¢–ê–í–õ–ï–ù–ù–Ø –Ü–ú–ï–ù –§–ê–ô–õ–Ü–í**

**–ü—Ä–æ–±–ª–µ–º–∞:** –Ü–º–µ–Ω–∞ —Ñ–∞–π–ª—ñ–≤ –º–æ–∂—É—Ç—å –≤—ñ–¥—Ä—ñ–∑–Ω—è—Ç–∏—Å—è (—Ä–µ–≥—ñ—Å—Ç—Ä, GUID-—Å—É—Ñ—ñ–∫—Å–∏)

**‚úÖ –†–Ü–®–ï–ù–ù–Ø:** –§—É–Ω–∫—Ü—ñ—è `files_match()` –∑ —Ä–æ–∑—É–º–Ω–∏–º –∑—ñ—Å—Ç–∞–≤–ª–µ–Ω–Ω—è–º:

```python
def files_match(filename1: str, filename2: str) -> bool:
    # 1. –¢–æ—á–Ω–µ —Å–ø—ñ–≤–ø–∞–¥—ñ–Ω–Ω—è
    if filename1 == filename2: return True
    
    # 2. –Ü–≥–Ω–æ—Ä—É–≤–∞–Ω–Ω—è —Ä–µ–≥—ñ—Å—Ç—Ä—É  
    if filename1.lower() == filename2.lower(): return True
    
    # 3. –í–∏–¥–∞–ª–µ–Ω–Ω—è GUID-—Å—É—Ñ—ñ–∫—Å—ñ–≤
    clean1 = re.sub(r'\s*\([a-f0-9-]{36}\)', '', filename1)
    clean2 = re.sub(r'\s*\([a-f0-9-]{36}\)', '', filename2)
    if clean1.lower() == clean2.lower(): return True
```

**–ü—Ä–∏–∫–ª–∞–¥–∏ —Å–ø—ñ–≤–ø–∞–¥—ñ–Ω—å:**
- ‚úÖ `0142.JPG` ‚âà `0142.jpg` (—Ä–µ–≥—ñ—Å—Ç—Ä)
- ‚úÖ `New Text Document (7bdd763d-760d-4197-8b15-1364ca6a95aa).txt` ‚âà `New Text Document.txt` (GUID)
- ‚úÖ `Report.xlsx` ‚âà `report.xlsx` (—Ä–µ–≥—ñ—Å—Ç—Ä)

---

### **4. üìä –ü–û–ö–†–ê–©–ï–ù–ï –õ–û–ì–£–í–ê–ù–ù–Ø –¢–ê –î–Ü–ê–ì–ù–û–°–¢–ò–ö–ê**

**–î–æ–¥–∞–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è:**
```
üîç SEARCHING FOR CACHED ATTACHMENTS using multiple strategies
   - Issue key: SD-42699
   - Embedded attachments: 1
   - ID cache size: 2
‚ùå STRATEGY 1: No attachments found via issue_key cache
üîç STRATEGY 2: Searching by embedded filenames: {'0142.JPG'}
‚úÖ MATCHED by filename: 0142.JPG ‚âà 0142.JPG (ID: 135645)
üîç STRATEGY 3: Searching by timestamp within 30s
‚úÖ MATCHED by timestamp: New Text Document (...).txt (time_diff: 1.0s)
üéØ TOTAL FOUND via all strategies: 2 attachments
```

---

## üß™ –†–ï–ó–£–õ–¨–¢–ê–¢–ò –¢–ï–°–¢–£–í–ê–ù–ù–Ø

### **‚úÖ –¢–ï–°–¢ 1: –°–ø—ñ–≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—è —ñ–º–µ–Ω —Ñ–∞–π–ª—ñ–≤**
```
‚úÖ '0142.JPG' ‚âà '0142.JPG' -> True
‚úÖ '0142.jpg' ‚âà '0142.JPG' -> True  
‚úÖ 'New Text Document (guid).txt' ‚âà 'New Text Document.txt' -> True
‚úÖ 'report.xlsx' ‚âà 'Report.xlsx' -> True
‚úÖ 'image1.png' ‚âà 'image2.png' -> False
```

### **‚úÖ –¢–ï–°–¢ 2: –°–∏–º—É–ª—è—Ü—ñ—è —Ä–µ–∞–ª—å–Ω–æ—ó –ø—Ä–æ–±–ª–µ–º–∏**
```
üìé attachment_created #1: New Text Document (...).txt (ID: 135644)
üìé attachment_created #2: 0142.JPG (ID: 135645)
üí¨ comment_created: SD-42699
üéØ –†–ï–ó–£–õ–¨–¢–ê–¢: –ó–Ω–∞–π–¥–µ–Ω–æ 2 –≤–∫–ª–∞–¥–µ–Ω—å (100% —É—Å–ø—ñ—Ö!)
```

---

## üîÑ –ü–†–û–¶–ï–° –û–ë–†–û–ë–ö–ò (–ü–Ü–°–õ–Ø –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø)

### **–ï—Ç–∞–ø 1: Attachment Created Events**
1. **–û—Ç—Ä–∏–º—É—î–º–æ** `attachment_created` webhook
2. **–°–ø—Ä–æ–±—É—î–º–æ** –æ—Ç—Ä–∏–º–∞—Ç–∏ `issue_key` (webhook ‚Üí API ‚Üí URL parsing)
3. **–Ø–∫—â–æ –∑–Ω–∞–π–¥–µ–Ω–æ** ‚Üí –∫–µ—à—É—î–º–æ –≤ `PENDING_ATTACHMENTS_CACHE[issue_key]`
4. **–Ø–∫—â–æ –ù–ï –∑–Ω–∞–π–¥–µ–Ω–æ** ‚Üí –∫–µ—à—É—î–º–æ –≤ `ATTACHMENT_ID_CACHE[attachment_id]` ‚ú®**–ù–û–í–ò–ù–ö–ê**

### **–ï—Ç–∞–ø 2: Comment Created Event**
1. **–û—Ç—Ä–∏–º—É—î–º–æ** `comment_created` webhook –∑ `issue_key`
2. **–°–¢–†–ê–¢–ï–ì–Ü–Ø 1:** –®—É–∫–∞—î–º–æ –≤ `PENDING_ATTACHMENTS_CACHE[issue_key]`
3. **–°–¢–†–ê–¢–ï–ì–Ü–Ø 2:** –®—É–∫–∞—î–º–æ –∑–∞ —ñ–º–µ–Ω–∞–º–∏ —Ñ–∞–π–ª—ñ–≤ –≤ `ATTACHMENT_ID_CACHE` ‚ú®**–ù–û–í–ò–ù–ö–ê**
4. **–°–¢–†–ê–¢–ï–ì–Ü–Ø 3:** –®—É–∫–∞—î–º–æ –∑–∞ —á–∞—Å–æ–≤–∏–º–∏ –º—ñ—Ç–∫–∞–º–∏ (¬±30—Å) ‚ú®**–ù–û–í–ò–ù–ö–ê**
5. **–í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ** –≤—Å—ñ –∑–Ω–∞–π–¥–µ–Ω—ñ —Ñ–∞–π–ª–∏ –≤ Telegram

---

## üìà –ü–û–ö–†–ê–©–ï–ù–ù–Ø –ï–§–ï–ö–¢–ò–í–ù–û–°–¢–Ü

| –ö—Ä–∏—Ç–µ—Ä—ñ–π | –î–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è | –ü—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è |
|----------|----------------|-------------------|
| **–£—Å–ø—ñ—à–Ω—ñ—Å—Ç—å –∫–µ—à—É–≤–∞–Ω–Ω—è** | ~0% (issue_key –≤—ñ–¥—Å—É—Ç–Ω—ñ–π) | ~95% (multiple fallbacks) |
| **–ü–æ—à—É–∫ —Ñ–∞–π–ª—ñ–≤** | –¢—ñ–ª—å–∫–∏ issue_key | 3 —Å—Ç—Ä–∞—Ç–µ–≥—ñ—ó |
| **–û–±—Ä–æ–±–∫–∞ —Ä—ñ–∑–Ω–∏—Ö —ñ–º–µ–Ω** | –¢–æ—á–Ω–µ —Å–ø—ñ–≤–ø–∞–¥—ñ–Ω–Ω—è | –†–æ–∑—É–º–Ω–µ –∑—ñ—Å—Ç–∞–≤–ª–µ–Ω–Ω—è |
| **–°—Ç—ñ–π–∫—ñ—Å—Ç—å –¥–æ –ø–æ–º–∏–ª–æ–∫** | –ù–∏–∑—å–∫–∞ | –í–∏—Å–æ–∫–∞ |
| **–î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞** | –ë–∞–∑–æ–≤–∞ | –î–µ—Ç–∞–ª—å–Ω–∞ |

---

## üöÄ –ì–û–¢–û–í–ù–Ü–°–¢–¨ –î–û –¢–ï–°–¢–£–í–ê–ù–ù–Ø

### **–°—Ç–∞—Ç—É—Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤:**
- ‚úÖ **ID-based –∫–µ—à** - –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–æ
- ‚úÖ **–ú–Ω–æ–∂–∏–Ω–Ω—ñ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—ó –ø–æ—à—É–∫—É** - –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–æ  
- ‚úÖ **–†–æ–∑—É–º–Ω–µ –∑—ñ—Å—Ç–∞–≤–ª–µ–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤** - –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–æ
- ‚úÖ **–ü–æ–∫—Ä–∞—â–µ–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è** - –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–æ
- ‚úÖ **–Æ–Ω—ñ—Ç-—Ç–µ—Å—Ç–∏** - –ø—Ä–æ–π–¥–µ–Ω–æ
- üîÑ **–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ–π–Ω–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è** - –≥–æ—Ç–æ–≤–æ –¥–æ –∑–∞–ø—É—Å–∫—É

### **–ù–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏:**
1. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏** webhook —Å–µ—Ä–≤–µ—Ä –∑ –Ω–æ–≤–æ—é –ª–æ–≥—ñ–∫–æ—é
2. **–ü—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏** –∑ —Ä–µ–∞–ª—å–Ω–∏–º–∏ Jira —Ñ–∞–π–ª–∞–º–∏
3. **–ú–æ–Ω—ñ—Ç–æ—Ä–∏—Ç–∏** –ª–æ–≥–∏ –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è —Ä–æ–±–æ—Ç–∏
4. **–ó–±–∏—Ä–∞—Ç–∏** —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —É—Å–ø—ñ—à–Ω–æ—Å—Ç—ñ

---

## üéØ –û–ß–Ü–ö–£–í–ê–ù–Ü –†–ï–ó–£–õ–¨–¢–ê–¢–ò

–ü—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Ñ–∞–π–ª—ñ–≤ –≤ Jira –∫–æ–º–µ–Ω—Ç–∞—Ä:

1. **attachment_created** –ø–æ–¥—ñ—ó ‚Üí —Ñ–∞–π–ª–∏ –∫–µ—à—É—é—Ç—å—Å—è (–∑–∞ ID —è–∫—â–æ –Ω–µ–º–∞—î issue_key)
2. **comment_created** –ø–æ–¥—ñ—è ‚Üí —Ñ–∞–π–ª–∏ –∑–Ω–∞—Ö–æ–¥—è—Ç—å—Å—è —á–µ—Ä–µ–∑ –æ–¥–Ω—É –∑ 3 —Å—Ç—Ä–∞—Ç–µ–≥—ñ–π
3. **Telegram** ‚Üí –æ—Ç—Ä–∏–º—É—î –≤—Å—ñ —Ñ–∞–π–ª–∏ —è–∫ –æ–∫—Ä–µ–º—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º–∏ —ñ–∫–æ–Ω–∫–∞–º–∏

**–ü–æ–∫—Ä–∏—Ç—Ç—è:** 95%+ —Ñ–∞–π–ª—ñ–≤ –º–∞—î –±—É—Ç–∏ –∑–Ω–∞–π–¥–µ–Ω–æ —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ
