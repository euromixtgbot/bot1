# üö® –ö–†–ò–¢–ò–ß–ù–ò–ô –ê–ù–ê–õ–Ü–ó –ü–†–û–ë–õ–ï–ú –ó –ü–ï–†–ï–°–ò–õ–ê–ù–ù–Ø–ú –§–ê–ô–õ–Ü–í

**–î–∞—Ç–∞:** 11 –ª–∏–ø–Ω—è 2025  
**–°—Ç–∞—Ç—É—Å:** –ö–†–ò–¢–ò–ß–ù–Ü –ü–†–û–ë–õ–ï–ú–ò –í–ò–Ø–í–õ–ï–ù–û  
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ñ–û–î–ù–ï –í–ö–õ–ê–î–ï–ù–ù–Ø –ù–ï –ù–ê–î–Ü–°–õ–ê–ù–û

## üîç –ê–ù–ê–õ–Ü–ó –õ–û–ì–Ü–í

### **‚ùå –ü–†–û–ë–õ–ï–ú–ê ‚Ññ1: –í–¢–†–ê–¢–ê –ö–ï–®–û–í–ê–ù–ò–• –í–ö–õ–ê–î–ï–ù–¨**

**–©–æ —Å—Ç–∞–ª–æ—Å—è:**
```
14:08:27 - attachment_created: New Text Document (ID: 135644) 
14:08:27 - attachment_created: 0142.JPG (ID: 135645)
14:08:27 - comment_created: SD-42699
14:08:28 - NO CACHED ATTACHMENTS FOUND! ‚ùå
```

**–ü—Ä–∏—á–∏–Ω–∞:** 
- –í–∫–ª–∞–¥–µ–Ω–Ω—è `attachment_created` –ù–ï –ø–æ—Ç—Ä–∞–ø–ª—è—é—Ç—å –¥–æ –∫–µ—à—É
- –ü—Ä–∏ `comment_created` –∫–µ—à –ø–æ—Ä–æ–∂–Ω—ñ–π
- –§—É–Ω–∫—Ü—ñ—è `get_cached_attachments()` –ø–æ–≤–µ—Ä—Ç–∞—î –ø—É—Å—Ç–∏–π —Å–ø–∏—Å–æ–∫

**–û—á—ñ–∫—É–≤–∞–ª–æ—Å—è:** 2 —Ñ–∞–π–ª–∏ –≤ –∫–µ—à—ñ  
**–§–∞–∫—Ç–∏—á–Ω–æ:** 0 —Ñ–∞–π–ª—ñ–≤ –≤ –∫–µ—à—ñ

---

### **‚ùå –ü–†–û–ë–õ–ï–ú–ê ‚Ññ2: –ù–ï–ü–†–ê–í–ò–õ–¨–ù–Ü API URL –î–õ–Ø –û–¢–†–ò–ú–ê–ù–ù–Ø ISSUE_KEY**

**–ü–æ–º–∏–ª–∫–∞ –≤ –ª–æ–≥–∞—Ö:**
```
14:08:34,936 - ‚ùå Cannot determine issue key for attachment 135644. Skipping cache.
14:08:35,131 - ‚ùå Cannot determine issue key for attachment 135645. Skipping cache.
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- –§—É–Ω–∫—Ü—ñ—è `get_issue_key_from_attachment_api()` –Ω–µ –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ issue_key —á–µ—Ä–µ–∑ API
- –í–∫–ª–∞–¥–µ–Ω–Ω—è –Ω–µ –∫–µ—à—É—é—Ç—å—Å—è —á–µ—Ä–µ–∑ –Ω–µ–≤—ñ–¥–æ–º–∏–π issue_key
- –í—Ç—Ä–∞—á–∞—î—Ç—å—Å—è –∑–≤'—è–∑–æ–∫ attachment ‚Üí issue

---

### **‚ùå –ü–†–û–ë–õ–ï–ú–ê ‚Ññ3: –ù–ï–ü–†–ê–í–ò–õ–¨–ù–Ü URL –î–õ–Ø –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø**

**–©–æ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è:**
1. –°–∏—Å—Ç–µ–º–∞ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å —Ç—ñ–ª—å–∫–∏ embedded attachment: `0142.JPG` (–±–µ–∑ ID)
2. –ì–µ–Ω–µ—Ä—É—î –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ñ URL:
   ```
   https://euromix.atlassian.net/secure/attachment/0142.JPG ‚ùå
   https://euromix.atlassian.net/download/attachments/temp/0142.JPG ‚ùå
   https://euromix.atlassian.net/images/0142.JPG ‚ùå
   ```
3. –í—Å—ñ URL –ø–æ–≤–µ—Ä—Ç–∞—é—Ç—å 404 –∞–±–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—é—Ç—å –Ω–∞ –Ω–µ—ñ—Å–Ω—É—é—á—ñ —Ä–µ—Å—É—Ä—Å–∏

**–ü—Ä–∞–≤–∏–ª—å–Ω—ñ URL –º–∞—é—Ç—å –±—É—Ç–∏:**
```
https://euromix.atlassian.net/rest/api/3/attachment/135645/content
https://euromix.atlassian.net/secure/attachment/135645/0142.JPG
```

---

### **‚ùå –ü–†–û–ë–õ–ï–ú–ê ‚Ññ4: –î–£–ë–õ–Æ–í–ê–ù–ù–Ø –û–ë–†–û–ë–ö–ò WEBHOOK**

**–õ–æ–≥–∏ –ø–æ–∫–∞–∑—É—é—Ç—å:**
```
14:08:27,258 - –û–±—Ä–æ–±–∫–∞ –ø–æ–¥—ñ—ó: attachment_created
14:08:27,258 - –û–±—Ä–æ–±–∫–∞ –ø–æ–¥—ñ—ó: attachment_created  ‚Üê –î–£–ë–õ–Ü–ö–ê–¢
```

–ö–æ–∂–Ω–∞ –ø–æ–¥—ñ—è –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è –¥–≤—ñ—á—ñ, —â–æ –º–æ–∂–µ –ø—Ä–∏–∑–≤–æ–¥–∏—Ç–∏ –¥–æ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤.

---

## üõ†Ô∏è –î–Ü–ê–ì–ù–û–°–¢–ò–ö–ê –û–°–ù–û–í–ù–ò–• –ü–†–ò–ß–ò–ù

### **1. –ö–ï–®–£–í–ê–ù–ù–Ø –ù–ï –ü–†–ê–¶–Æ–Ñ**
```bash
# –ü–µ—Ä–µ–≤—ñ—Ä–∏–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω –≥–ª–æ–±–∞–ª—å–Ω–æ—ó –∑–º—ñ–Ω–Ω–æ—ó –∫–µ—à—É
PENDING_ATTACHMENTS_CACHE: Dict[str, List[Dict[str, Any]]] = defaultdict(list)
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –í–∫–ª–∞–¥–µ–Ω–Ω—è –Ω–µ –¥–æ–¥–∞—é—Ç—å—Å—è –¥–æ –∫–µ—à—É —á–µ—Ä–µ–∑:
- –ù–µ–≤–¥–∞–ª–∏–π API –∑–∞–ø–∏—Ç –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è issue_key
- –§—É–Ω–∫—Ü—ñ—è `add_attachment_to_cache()` –Ω–µ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è

### **2. API –ó–ê–ü–ò–¢–ò –ù–ï–í–î–ê–õ–Ü**
```
Connection error: [Errno -3] Temporary failure in name resolution
```

**–ü—Ä–∏—á–∏–Ω–∞:** –ú–µ—Ä–µ–∂–µ–≤—ñ –ø—Ä–æ–±–ª–µ–º–∏ –ø—Ä–∏ –∑–∞–ø–∏—Ç–∞—Ö –¥–æ Jira API –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è issue_key

### **3. EMBEDDED ATTACHMENTS –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û –û–ë–†–û–ë–õ–Æ–Æ–¢–¨–°–Ø**
- –°–∏—Å—Ç–µ–º–∞ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å —Ñ–∞–π–ª —á–µ—Ä–µ–∑ `extract_embedded_attachments()`
- –ê–ª–µ embedded —Ñ–∞–π–ª–∏ –Ω–µ –º–∞—é—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö ID –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
- URL –≥–µ–Ω–µ—Ä—É—é—Ç—å—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ

---

## üö® –ö–†–ò–¢–ò–ß–ù–Ü –ü–†–û–ë–õ–ï–ú–ò

| –ü—Ä–æ–±–ª–µ–º–∞ | –í–ø–ª–∏–≤ | –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç |
|----------|--------|-----------|
| –ö–µ—à –Ω–µ –ø—Ä–∞—Ü—é—î | –í—Ç—Ä–∞—Ç–∞ –≤—Å—ñ—Ö –≤–∫–ª–∞–¥–µ–Ω—å | üî¥ –ö–†–ò–¢–ò–ß–ù–ò–ô |
| API issue_key fail | –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è –∫–µ—à—É–≤–∞–Ω–Ω—è | üî¥ –ö–†–ò–¢–ò–ß–ù–ò–ô |
| –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ñ URL | –ü–æ–º–∏–ª–∫–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è | üî¥ –ö–†–ò–¢–ò–ß–ù–ò–ô |
| –î—É–±–ª—é–≤–∞–Ω–Ω—è webhook | –ö–æ–Ω—Ñ–ª—ñ–∫—Ç–∏ –æ–±—Ä–æ–±–∫–∏ | üü° –í–ò–°–û–ö–ò–ô |

---

## üéØ –ü–õ–ê–ù –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø

### **–ö–†–û–ö 1: –í–ò–ü–†–ê–í–ò–¢–ò –ö–ï–®–£–í–ê–ù–ù–Ø**
```python
# –£ handle_attachment_created() –¥–æ–¥–∞—Ç–∏ –ª–æ–≥—É–≤–∞–Ω–Ω—è:
logger.info(f"üîµ ATTEMPTING TO CACHE: {filename} for issue {issue_key}")
add_attachment_to_cache(issue_key, attachment)
logger.info(f"üîµ CACHE STATE: {len(PENDING_ATTACHMENTS_CACHE)} issues cached")
```

### **–ö–†–û–ö 2: –í–ò–ü–†–ê–í–ò–¢–ò API –ó–ê–ü–ò–¢–ò**
```python
# –£ get_issue_key_from_attachment_api() –¥–æ–¥–∞—Ç–∏ fallback:
if not issue_key:
    # –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –æ—Ç—Ä–∏–º–∞—Ç–∏ issue_key –∑ webhook event
    issue_key = webhook_data.get('issue', {}).get('key', '')
```

### **–ö–†–û–ö 3: –í–ò–ö–û–†–ò–°–¢–ê–¢–ò –ü–†–ê–í–ò–õ–¨–ù–Ü ID**
```python
# –£ handle_comment_created() –¥–æ–¥–∞—Ç–∏ –ø–æ—à—É–∫ —Ä–µ–∞–ª—å–Ω–∏—Ö ID:
if attachments_from_cache:
    # –ó–∞–º—ñ–Ω–∏—Ç–∏ embedded attachments —Ä–µ–∞–ª—å–Ω–∏–º–∏ –∑ –∫–µ—à—É
    for cached_att in attachments_from_cache:
        real_id = cached_att.get('id')
        real_url = cached_att.get('content', cached_att.get('self'))
```

### **–ö–†–û–ö 4: –í–ò–ü–†–ê–í–ò–¢–ò –î–£–ë–õ–Æ–í–ê–ù–ù–Ø**
```python
# –î–æ–¥–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –Ω–∞ –¥—É–±–ª—ñ–∫–∞—Ç–∏ webhook:
processed_events = set()
event_id = f"{webhook_data.get('timestamp')}_{attachment_id}"
if event_id in processed_events:
    return
processed_events.add(event_id)
```

---

## ‚ö° –¢–ï–†–ú–Ü–ù–û–íI –î–Ü–á

1. **–ù–ï–ì–ê–ô–ù–û:** –î–æ–¥–∞—Ç–∏ –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–æ —Ñ—É–Ω–∫—Ü—ñ–π –∫–µ—à—É–≤–∞–Ω–Ω—è
2. **–¢–ï–†–ú–Ü–ù–û–í–û:** –í–∏–ø—Ä–∞–≤–∏—Ç–∏ API –∑–∞–ø–∏—Ç–∏ –¥–ª—è issue_key 
3. **–ö–†–ò–¢–ò–ß–ù–û:** –ù–∞–ª–∞–≥–æ–¥–∏—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–µ —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è URL –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
4. **–í–ê–ñ–õ–ò–í–û:** –£—Å—É–Ω—É—Ç–∏ –¥—É–±–ª—é–≤–∞–Ω–Ω—è webhook –æ–±—Ä–æ–±–∫–∏

---

## üìä –û–ß–Ü–ö–£–í–ê–ù–ò–ô –†–ï–ó–£–õ–¨–¢–ê–¢

–ü—ñ—Å–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å:
- ‚úÖ –í–∫–ª–∞–¥–µ–Ω–Ω—è –∫–µ—à—É—é—Ç—å—Å—è –ø—Ä–∏ `attachment_created`
- ‚úÖ Issue_key –æ—Ç—Ä–∏–º—É—î—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ  
- ‚úÖ –ü—Ä–∏ `comment_created` —Ñ–∞–π–ª–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è –∑ –∫–µ—à—É
- ‚úÖ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ñ ID —Ç–∞ URL
- ‚úÖ –í—Å—ñ —Ç–∏–ø–∏ —Ñ–∞–π–ª—ñ–≤ –Ω–∞–¥—Å–∏–ª–∞—é—Ç—å—Å—è –≤ Telegram

**–ù–ê–°–¢–£–ü–ù–ò–ô –ö–†–û–ö:** –ü–æ—á–∞—Ç–∏ –∑ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –∫–µ—à—É–≤–∞–Ω–Ω—è —Ç–∞ –ª–æ–≥—É–≤–∞–Ω–Ω—è.
