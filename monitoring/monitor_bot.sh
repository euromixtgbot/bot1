#!/bin/bash

# =====================================
# BOT MONITORING AND AUTO-RESTART SCRIPT
# =====================================
# –¶–µ–π —Å–∫—Ä–∏–ø—Ç –º–æ–Ω—ñ—Ç–æ—Ä–∏—Ç—å —Ä–æ–±–æ—Ç—É Telegram –±–æ—Ç–∞ —Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î –π–æ–≥–æ –ø—Ä–∏ –ø–æ—Ç—Ä–µ–±—ñ
# –ü–µ—Ä–µ–≤—ñ—Ä—è—î —Å—Ç–∞–Ω –±–æ—Ç–∞ –∫–æ–∂–Ω—ñ 15 —Ö–≤–∏–ª–∏–Ω
# –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î –±–æ—Ç, –ø–æ—Ç—ñ–º —Å–µ—Ä–≤–µ—Ä —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ

# –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
BOT_DIR="/home/Bot1"
BOT_SCRIPT="src/main.py"
VENV_PATH="$BOT_DIR/venv"
ACTIVATE_SCRIPT="$BOT_DIR/activate_and_run.sh"
LOG_FILE="$BOT_DIR/logs/monitor.log"
PID_FILE="$BOT_DIR/bot.pid"
MAX_RESTART_ATTEMPTS=3
RESTART_COOLDOWN=60  # —Å–µ–∫—É–Ω–¥–∏ –º—ñ–∂ —Å–ø—Ä–æ–±–∞–º–∏
SERVER_RESTART_DELAY=120  # —Å–µ–∫—É–Ω–¥–∏ –ø—ñ—Å–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É —Å–µ—Ä–≤–µ—Ä–∞
CHECK_INTERVAL=900  # 15 —Ö–≤–∏–ª–∏–Ω –≤ —Å–µ–∫—É–Ω–¥–∞—Ö

# –ö–æ–ª—å–æ—Ä–∏ –¥–ª—è –≤–∏–≤–æ–¥—É
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü—ñ—è –ª–æ–≥—É–≤–∞–Ω–Ω—è
log() {
    local level=$1
    shift
    local message="$@"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo -e "[$timestamp] [$level] $message" | tee -a "$LOG_FILE"
}

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —á–∏ –ø—Ä–∞—Ü—é—î –±–æ—Ç
is_bot_running() {
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ø–æ PID —Ñ–∞–π–ª—É
    if [[ -f "$PID_FILE" ]]; then
        local pid=$(cat "$PID_FILE")
        if ps -p "$pid" > /dev/null 2>&1; then
            # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ü–µ –¥—ñ–π—Å–Ω–æ –Ω–∞—à –±–æ—Ç
            if ps -p "$pid" -o cmd --no-headers | grep -q "python.*main.py"; then
                return 0  # –ë–æ—Ç –ø—Ä–∞—Ü—é—î
            fi
        fi
        # PID —Ñ–∞–π–ª —ñ—Å–Ω—É—î, –∞–ª–µ –ø—Ä–æ—Ü–µ—Å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∏–π - –≤–∏–¥–∞–ª—è—î–º–æ —Ñ–∞–π–ª
        rm -f "$PID_FILE"
    fi
    
    # –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ –Ω–∞–∑–≤—ñ –ø—Ä–æ—Ü–µ—Å—É
    if pgrep -f "python.*$BOT_SCRIPT" > /dev/null; then
        return 0  # –ë–æ—Ç –ø—Ä–∞—Ü—é—î
    fi
    
    return 1  # –ë–æ—Ç –Ω–µ –ø—Ä–∞—Ü—é—î
}

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑—É–ø–∏–Ω–∫–∏ –±–æ—Ç–∞
stop_bot() {
    log "INFO" "üõë –ó—É–ø–∏–Ω–∫–∞ –±–æ—Ç–∞..."
    
    # –ó—É–ø–∏–Ω–∫–∞ –ø–æ PID —Ñ–∞–π–ª—É
    if [[ -f "$PID_FILE" ]]; then
        local pid=$(cat "$PID_FILE")
        if ps -p "$pid" > /dev/null 2>&1; then
            kill "$pid" 2>/dev/null
            sleep 3
            
            # –Ø–∫—â–æ –ø—Ä–æ—Ü–µ—Å –≤—Å–µ —â–µ –ø—Ä–∞—Ü—é—î, –ø—Ä–∏–º—É—Å–æ–≤–∞ –∑—É–ø–∏–Ω–∫–∞
            if ps -p "$pid" > /dev/null 2>&1; then
                kill -9 "$pid" 2>/dev/null
                sleep 2
            fi
        fi
        rm -f "$PID_FILE"
    fi
    
    # –ó—É–ø–∏–Ω–∫–∞ –≤—Å—ñ—Ö –ø—Ä–æ—Ü–µ—Å—ñ–≤ –±–æ—Ç–∞
    pkill -f "python.*$BOT_SCRIPT" 2>/dev/null
    sleep 2
    
    # –ü—Ä–∏–º—É—Å–æ–≤–∞ –∑—É–ø–∏–Ω–∫–∞ —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
    pkill -9 -f "python.*$BOT_SCRIPT" 2>/dev/null
    
    log "INFO" "‚úÖ –ë–æ—Ç –∑—É–ø–∏–Ω–µ–Ω–æ"
}

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–ø—É—Å–∫—É –±–æ—Ç–∞
start_bot() {
    log "INFO" "üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
    
    cd "$BOT_DIR" || {
        log "ERROR" "‚ùå –ù–µ –≤–¥–∞—î—Ç—å—Å—è –ø–µ—Ä–µ–π—Ç–∏ –¥–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó $BOT_DIR"
        return 1
    }
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
    if [[ ! -d "$VENV_PATH" ]]; then
        log "ERROR" "‚ùå –í—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ: $VENV_PATH"
        return 1
    fi
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å —Å–∫—Ä–∏–ø—Ç–∞ –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó
    if [[ ! -f "$ACTIVATE_SCRIPT" ]]; then
        log "ERROR" "‚ùå –°–∫—Ä–∏–ø—Ç –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ: $ACTIVATE_SCRIPT"
        return 1
    fi
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –±–æ—Ç–∞
    if [[ ! -f "$BOT_SCRIPT" ]]; then
        log "ERROR" "‚ùå –§–∞–π–ª $BOT_SCRIPT –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"
        return 1
    fi
    
    # –ó–∞–ø—É—Å–∫–∞—î–º–æ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ –≤ —Ñ–æ–Ω—ñ
    nohup bash -c "
        cd '$BOT_DIR'
        source '$VENV_PATH/bin/activate'
        export PYTHONPATH='$BOT_DIR:\$PYTHONPATH'
        python '$BOT_SCRIPT'
    " > /dev/null 2>&1 &
    
    local bot_pid=$!
    
    # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ PID
    echo "$bot_pid" > "$PID_FILE"
    
    # –ß–µ–∫–∞—î–º–æ —Ç—Ä–æ—Ö–∏ —ñ –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –∑–∞–ø—É—Å—Ç–∏–≤—Å—è
    sleep 5
    
    if ps -p "$bot_pid" > /dev/null 2>&1; then
        log "INFO" "‚úÖ –ë–æ—Ç —É—Å–ø—ñ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–æ (PID: $bot_pid)"
        return 0
    else
        log "ERROR" "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –±–æ—Ç–∞"
        rm -f "$PID_FILE"
        return 1
    fi
}

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É –±–æ—Ç–∞
restart_bot() {
    log "INFO" "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
    stop_bot
    sleep 3
    start_bot
}

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É —Å–µ—Ä–≤–µ—Ä–∞
restart_server() {
    log "WARNING" "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ —á–µ—Ä–µ–∑ –∫—Ä–∏—Ç–∏—á–Ω—É –ø–æ–º–∏–ª–∫—É..."
    
    # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
    echo "$(date '+%Y-%m-%d %H:%M:%S') - Server restart initiated by bot monitor" >> "$BOT_DIR/logs/server_restarts.log"
    
    # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
    sudo reboot
}

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤'—è –±–æ—Ç–∞
health_check() {
    local attempt=1
    
    while [[ $attempt -le $MAX_RESTART_ATTEMPTS ]]; do
        log "INFO" "üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞–Ω—É –±–æ—Ç–∞ (—Å–ø—Ä–æ–±–∞ $attempt/$MAX_RESTART_ATTEMPTS)..."
        
        if is_bot_running; then
            log "INFO" "‚úÖ –ë–æ—Ç –ø—Ä–∞—Ü—é—î –Ω–æ—Ä–º–∞–ª—å–Ω–æ"
            return 0
        else
            log "WARNING" "‚ö†Ô∏è –ë–æ—Ç –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î. –°–ø—Ä–æ–±–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É $attempt/$MAX_RESTART_ATTEMPTS"
            
            if [[ $attempt -eq 1 ]]; then
                # –ü–µ—Ä—à–∞ —Å–ø—Ä–æ–±–∞ - —á–µ–∫–∞—î–º–æ 1 —Ö–≤–∏–ª–∏–Ω—É —ñ –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∑–Ω–æ–≤—É
                log "INFO" "‚è±Ô∏è –û—á—ñ–∫—É–≤–∞–Ω–Ω—è 1 —Ö–≤–∏–ª–∏–Ω–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º..."
                sleep 60
                
                if is_bot_running; then
                    log "INFO" "‚úÖ –ë–æ—Ç –≤—ñ–¥–Ω–æ–≤–∏–≤—Å—è —Å–∞–º–æ—Å—Ç—ñ–π–Ω–æ"
                    return 0
                fi
            fi
            
            # –°–ø—Ä–æ–±–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É
            if restart_bot; then
                log "INFO" "‚úÖ –ë–æ—Ç —É—Å–ø—ñ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ"
                return 0
            else
                log "ERROR" "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –±–æ—Ç–∞ (—Å–ø—Ä–æ–±–∞ $attempt)"
                
                if [[ $attempt -eq $MAX_RESTART_ATTEMPTS ]]; then
                    log "CRITICAL" "üö® –í—Å—ñ —Å–ø—Ä–æ–±–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É –≤–∏—á–µ—Ä–ø–∞–Ω–æ. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞..."
                    restart_server
                    exit 1
                fi
                
                # –ß–µ–∫–∞—î–º–æ –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—É–ø–Ω–æ—é —Å–ø—Ä–æ–±–æ—é
                log "INFO" "‚è±Ô∏è –û—á—ñ–∫—É–≤–∞–Ω–Ω—è $RESTART_COOLDOWN —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—É–ø–Ω–æ—é —Å–ø—Ä–æ–±–æ—é..."
                sleep $RESTART_COOLDOWN
            fi
        fi
        
        ((attempt++))
    done
    
    return 1
}

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
initialize() {
    # –°—Ç–≤–æ—Ä—é—î–º–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é –¥–ª—è –ª–æ–≥—ñ–≤ —è–∫—â–æ –Ω–µ —ñ—Å–Ω—É—î
    mkdir -p "$BOT_DIR/logs"
    
    # –°—Ç–≤–æ—Ä—é—î–º–æ —Ñ–∞–π–ª –ª–æ–≥—ñ–≤ —è–∫—â–æ –Ω–µ —ñ—Å–Ω—É—î
    touch "$LOG_FILE"
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø—É
    if [[ ! -w "$BOT_DIR" ]]; then
        echo "‚ùå –ù–µ–º–∞—î –ø—Ä–∞–≤ –¥–ª—è –∑–∞–ø–∏—Å—É –≤ $BOT_DIR"
        exit 1
    fi
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
    if [[ ! -d "$VENV_PATH" ]]; then
        log "ERROR" "‚ùå –í—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ: $VENV_PATH"
        log "INFO" "üí° –°—Ç–≤–æ—Ä—ñ—Ç—å –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ: python3 -m venv $VENV_PATH"
        exit 1
    fi
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∞–∫—Ç–∏–≤–∞—Ü—ñ—é –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
    if [[ ! -f "$VENV_PATH/bin/activate" ]]; then
        log "ERROR" "‚ùå –§–∞–π–ª –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ: $VENV_PATH/bin/activate"
        exit 1
    fi
    
    log "INFO" "üîß –ú–æ–Ω—ñ—Ç–æ—Ä –±–æ—Ç–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ"
    log "INFO" "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è –±–æ—Ç–∞: $BOT_DIR"
    log "INFO" "üêç –í—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ: $VENV_PATH"
    log "INFO" "üìù –§–∞–π–ª –ª–æ–≥—ñ–≤: $LOG_FILE"
    log "INFO" "‚è∞ –Ü–Ω—Ç–µ—Ä–≤–∞–ª –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏: $CHECK_INTERVAL —Å–µ–∫—É–Ω–¥ ($(($CHECK_INTERVAL/60)) —Ö–≤–∏–ª–∏–Ω)"
}

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–±—Ä–æ–±–∫–∏ —Å–∏–≥–Ω–∞–ª—ñ–≤
cleanup() {
    log "INFO" "üõë –û—Ç—Ä–∏–º–∞–Ω–æ —Å–∏–≥–Ω–∞–ª –∑—É–ø–∏–Ω–∫–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∞"
    exit 0
}

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ —Å–∏–≥–Ω–∞–ª—ñ–≤
trap cleanup SIGTERM SIGINT

# –û—Å–Ω–æ–≤–Ω–∏–π —Ü–∏–∫–ª –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É
main_loop() {
    log "INFO" "üöÄ –ó–∞–ø—É—Å–∫ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –±–æ—Ç–∞..."
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –±–æ—Ç –ø—Ä–∞—Ü—é—î –ø—Ä–∏ –∑–∞–ø—É—Å–∫—É
    if ! is_bot_running; then
        log "INFO" "üîÑ –ë–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω–∏–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ –º–æ–Ω—ñ—Ç–æ—Ä–∞. –ó–∞–ø—É—Å–∫–∞—î–º–æ..."
        start_bot
    fi
    
    while true; do
        health_check
        
        log "INFO" "‚è±Ô∏è –ù–∞—Å—Ç—É–ø–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–µ—Ä–µ–∑ $(($CHECK_INTERVAL/60)) —Ö–≤–∏–ª–∏–Ω..."
        sleep $CHECK_INTERVAL
    done
}

# –§—É–Ω–∫—Ü—ñ—è –ø–æ–∫–∞–∑—É —Å—Ç–∞—Ç—É—Å—É
show_status() {
    echo -e "${BLUE}=== BOT MONITOR STATUS ===${NC}"
    echo -e "–î–∏—Ä–µ–∫—Ç–æ—Ä—ñ—è –±–æ—Ç–∞: ${GREEN}$BOT_DIR${NC}"
    echo -e "–í—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ: ${GREEN}$VENV_PATH${NC}"
    echo -e "–§–∞–π–ª –ª–æ–≥—ñ–≤: ${GREEN}$LOG_FILE${NC}"
    echo -e "PID —Ñ–∞–π–ª: ${GREEN}$PID_FILE${NC}"
    echo ""
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞
    if [[ -d "$VENV_PATH" ]]; then
        echo -e "–í—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ: ${GREEN}–ó–ù–ê–ô–î–ï–ù–û${NC}"
    else
        echo -e "–í—ñ—Ä—Ç—É–∞–ª—å–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ: ${RED}–ù–ï –ó–ù–ê–ô–î–ï–ù–û${NC}"
    fi
    
    if is_bot_running; then
        local pid=$(pgrep -f "python.*$BOT_SCRIPT")
        echo -e "–°—Ç–∞—Ç—É—Å –±–æ—Ç–∞: ${GREEN}–ü–†–ê–¶–Æ–Ñ${NC} (PID: $pid)"
    else
        echo -e "–°—Ç–∞—Ç—É—Å –±–æ—Ç–∞: ${RED}–ù–ï –ü–†–ê–¶–Æ–Ñ${NC}"
    fi
    
    echo ""
    echo -e "–Ü–Ω—Ç–µ—Ä–≤–∞–ª –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏: ${YELLOW}$(($CHECK_INTERVAL/60)) —Ö–≤–∏–ª–∏–Ω${NC}"
    echo -e "–ú–∞–∫—Å–∏–º—É–º —Å–ø—Ä–æ–± –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É: ${YELLOW}$MAX_RESTART_ATTEMPTS${NC}"
    echo ""
    
    if [[ -f "$LOG_FILE" ]]; then
        echo -e "${BLUE}=== –û–°–¢–ê–ù–ù–Ü –ó–ê–ü–ò–°–ò –õ–û–ì–£ ===${NC}"
        tail -10 "$LOG_FILE"
    fi
}

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–≥–æ —Ä—è–¥–∫–∞
case "${1:-}" in
    "start")
        initialize
        main_loop
        ;;
    "stop")
        echo "üõë –ó—É–ø–∏–Ω–∫–∞ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É..."
        pkill -f "monitor_bot.sh" 2>/dev/null
        echo "‚úÖ –ú–æ–Ω—ñ—Ç–æ—Ä –∑—É–ø–∏–Ω–µ–Ω–æ"
        ;;
    "restart")
        echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É..."
        pkill -f "monitor_bot.sh" 2>/dev/null
        sleep 2
        "$0" start &
        echo "‚úÖ –ú–æ–Ω—ñ—Ç–æ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ"
        ;;
    "status")
        show_status
        ;;
    "check")
        initialize
        health_check
        ;;
    *)
        echo -e "${BLUE}=== BOT MONITOR SCRIPT ===${NC}"
        echo "–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: $0 {start|stop|restart|status|check}"
        echo ""
        echo "–ö–æ–º–∞–Ω–¥–∏:"
        echo "  start   - –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥"
        echo "  stop    - –ó—É–ø–∏–Ω–∏—Ç–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥"
        echo "  restart - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥"
        echo "  status  - –ü–æ–∫–∞–∑–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å"
        echo "  check   - –û–¥–Ω–æ—Ä–∞–∑–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞"
        exit 1
        ;;
esac
